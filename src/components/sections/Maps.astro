---
const serviceAreas = [
    "Les 20 premiers kilomètres réels autour de Boutier-Saint-Trojan vous sont offerts",
    "Les suivants à 50 centimes / kilomètre",
    "Péage à votre charge",
    "Frais divisibles par le nombre d'animaux au même endroit",
];
---

<section id="maps" class="maps">
    <div class="section-header">
        <span class="section-label">Où nous trouver</span>
        <h2>Zone d'Intervention</h2>
        <div class="divider"></div>
    </div>
    <p class="maps-description">
        Découvrez nos zones de déplacement et tarifs associés
    </p>

    <div class="maps-grid">
        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="info-container">
            <h3>Frais de déplacement</h3>
            <div class="service-areas">
                <ul>
                    {serviceAreas.map((area) => <li>{area}</li>)}
                </ul>
            </div>
            <button id="openCalculator" class="calculator-button">
                Calculer les frais de déplacement
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Calculateur de frais</h3>
                <button id="closeModal" class="close-button">✕</button>
            </div>

            <div class="modal-body">
                <div class="warning-box">
                    <p>
                        Attention : Les montants affichés sont donnés à titre
                        indicatif et peuvent varier. Pour obtenir une
                        confirmation du tarif exact, veuillez nous contacter
                        directement.
                    </p>
                </div>

                <div class="form-group">
                    <label for="address">Votre adresse</label>
                    <div class="input-wrapper">
                        <input
                            type="text"
                            id="address"
                            placeholder="Saisissez votre adresse"
                            autocomplete="off"
                        />
                        <div id="loader" class="loader hidden"></div>
                    </div>
                    <div id="suggestions" class="suggestions"></div>
                </div>

                <div id="error" class="error-box hidden"></div>
                <div id="result" class="result-box hidden"></div>
            </div>
        </div>
    </div>
</section>

<style>
    .maps {
        background: var(--secondary-color);
        padding: 6rem 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .section-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .section-label {
        display: inline-block;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--accent-color);
        font-weight: 500;
        margin-bottom: 0.75rem;
    }

    .section-header h2 {
        margin-bottom: 1rem;
    }

    .divider {
        width: 60px;
        height: 3px;
        background: var(--primary-color);
        margin: 0 auto;
    }

    .maps-description {
        text-align: center;
        margin-bottom: 3rem;
        color: var(--text-medium);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        font-size: 1.05rem;
    }

    .maps-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        margin-top: 3rem;
    }

    .map-container {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        background: white;
        height: 100%;
        min-height: 500px;
    }

    #map {
        height: 100%;
        width: 100%;
    }

    .info-container {
        background: white;
        padding: 3rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .info-container h3 {
        text-align: center;
        font-size: 1.75rem;
        margin-bottom: 2rem;
        color: var(--primary-color);
    }

    .service-areas {
        flex: 1;
    }

    .service-areas ul {
        list-style: none;
        padding-left: 0;
        margin-bottom: 2rem;
    }

    .service-areas li {
        padding: 1rem 0;
        padding-left: 2.5rem;
        position: relative;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
        color: var(--text-medium);
        line-height: 1.6;
    }

    .service-areas li:last-child {
        border-bottom: none;
    }

    .service-areas li::before {
        content: "✓";
        position: absolute;
        left: 0;
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.2rem;
    }

    .calculator-button {
        width: 100%;
        margin-top: 2rem;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
        color: var(--primary-color);
        font-size: 1.5rem;
        margin: 0;
    }

    .close-button {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-light);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .close-button:hover {
        background: var(--border-color);
        color: var(--text-dark);
    }

    .modal-body {
        padding: 2rem;
    }

    .warning-box {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 4px;
    }

    .warning-box p {
        font-size: 0.875rem;
        color: #92400e;
        margin: 0;
        line-height: 1.6;
    }

    .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
        font-weight: 500;
        font-size: 0.9rem;
    }

    .input-wrapper {
        position: relative;
    }

    .loader {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border: 2px solid var(--primary-color);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .loader.hidden {
        display: none;
    }

    @keyframes spin {
        to {
            transform: translateY(-50%) rotate(360deg);
        }
    }

    .suggestions {
        position: absolute;
        z-index: 10;
        width: 100%;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-shadow: var(--shadow-md);
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
    }

    .suggestion-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s ease;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover {
        background: var(--border-color);
    }

    .error-box {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .error-box p {
        color: #991b1b;
        font-size: 0.875rem;
        margin: 0;
    }

    .error-box.hidden {
        display: none;
    }

    .result-box {
        background: #f3f4f6;
        padding: 1.5rem;
        border-radius: 4px;
        margin-top: 1rem;
    }

    .result-box p {
        margin: 0.5rem 0;
        font-size: 0.9rem;
        color: var(--text-medium);
    }

    .result-box p:last-child {
        font-size: 0.8rem;
        font-style: italic;
        color: var(--text-light);
    }

    .result-box.hidden {
        display: none;
    }

    @media (max-width: 968px) {
        .maps-grid {
            grid-template-columns: 1fr;
        }

        #map {
            height: 100%;
        }
    }

    @media (max-width: 768px) {
        .maps {
            padding: 4rem 1.5rem;
        }

        .info-container {
            padding: 2rem;
        }
    }
</style>

<script>
    import L from "leaflet";

    const COGNAC_POSITION = [45.71280718539304, -0.298026133009971];
    const FREE_KILOMETERS = 20;
    const PRICE_PER_KM = 0.5;

    let map: L.Map;
    let suggestions: any[] = [];

    // Initialize map
    document.addEventListener("DOMContentLoaded", () => {
        // Prevent duplicate map initialization
        const mapElement = document.getElementById("map") as any;
        if (mapElement._leaflet_id) {
            return;
        }

        map = L.map("map", {
            dragging: false,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            touchZoom: true,
            zoomControl: true,
        }).setView(COGNAC_POSITION, 9);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(map);

        // Default marker
        L.marker(COGNAC_POSITION).addTo(map);

        // Modal controls
        const modal = document.getElementById("calculatorModal");
        const openBtn = document.getElementById("openCalculator");
        const closeBtn = document.getElementById("closeModal");
        const addressInput = document.getElementById(
            "address",
        ) as HTMLInputElement;
        const suggestionsDiv = document.getElementById("suggestions");
        const loader = document.getElementById("loader");
        const errorBox = document.getElementById("error");
        const resultBox = document.getElementById("result");

        openBtn?.addEventListener("click", () => {
            modal?.classList.add("active");
        });

        closeBtn?.addEventListener("click", () => {
            modal?.classList.remove("active");
            resetCalculator();
        });

        modal?.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.remove("active");
                resetCalculator();
            }
        });

        // Address autocomplete
        let debounceTimer: ReturnType<typeof setTimeout>;
        addressInput?.addEventListener("input", (e) => {
            const value = (e.target as HTMLInputElement).value;

            clearTimeout(debounceTimer);

            if (value.length < 3) {
                if (suggestionsDiv) suggestionsDiv.innerHTML = "";
                return;
            }

            loader?.classList.remove("hidden");

            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(
                        `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(value)}&limit=5`,
                    );
                    const data = await response.json();
                    suggestions = data.features || [];
                    displaySuggestions(suggestions);
                } catch (error) {
                    console.error("Erreur lors de la recherche:", error);
                } finally {
                    loader?.classList.add("hidden");
                }
            }, 300);
        });

        function displaySuggestions(items: any[]) {
            if (!suggestionsDiv) return;

            suggestionsDiv.innerHTML = items
                .map(
                    (item) =>
                        `<div class="suggestion-item" data-id="${item.properties.id}">
                    ${item.properties.label}
                </div>`,
                )
                .join("");

            suggestionsDiv
                .querySelectorAll(".suggestion-item")
                .forEach((el, index) => {
                    el.addEventListener("click", () =>
                        handleSelectAddress(items[index]),
                    );
                });
        }

        async function handleSelectAddress(feature: any) {
            if (
                !addressInput ||
                !suggestionsDiv ||
                !errorBox ||
                !resultBox ||
                !loader
            )
                return;

            addressInput.value = feature.properties.label;
            suggestionsDiv.innerHTML = "";
            errorBox.classList.add("hidden");
            loader.classList.remove("hidden");

            try {
                const [lon, lat] = feature.geometry.coordinates;

                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${COGNAC_POSITION[1]},${COGNAC_POSITION[0]};${lon},${lat}?overview=false`,
                );
                const data = await response.json();

                if (data.code === "Ok" && data.routes && data.routes[0]) {
                    const distanceInKm = Math.round(
                        data.routes[0].distance / 1000,
                    );
                    const extraKm = Math.max(0, distanceInKm - FREE_KILOMETERS);
                    const price = extraKm * PRICE_PER_KM;

                    resultBox.classList.remove("hidden");
                    resultBox.innerHTML = `
                        <p><strong>Distance par la route :</strong> ${distanceInKm} km</p>
                        <p><strong>Prix estimé :</strong> ${distanceInKm <= FREE_KILOMETERS ? "Déplacement gratuit !" : price.toFixed(2) + "€"}</p>
                        <p>*Prix indicatif hors péage</p>
                    `;
                } else {
                    showError(
                        "Impossible de calculer l'itinéraire pour cette adresse",
                    );
                }
            } catch (error) {
                showError(
                    "Une erreur est survenue lors du calcul de la distance",
                );
            } finally {
                loader.classList.add("hidden");
            }
        }

        function showError(message) {
            if (!errorBox) return;
            errorBox.classList.remove("hidden");
            errorBox.innerHTML = `<p>${message}</p>`;
        }

        function resetCalculator() {
            if (!addressInput || !suggestionsDiv || !errorBox || !resultBox)
                return;
            addressInput.value = "";
            suggestionsDiv.innerHTML = "";
            errorBox.classList.add("hidden");
            resultBox.classList.add("hidden");
        }
    });
</script>
